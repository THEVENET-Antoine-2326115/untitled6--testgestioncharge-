<?php
namespace modules\blog\models;

/**
 * Classe DashboardModel
 *
 * Cette classe g√®re les donn√©es n√©cessaires pour le tableau de bord
 * en d√©l√©guant les t√¢ches aux mod√®les sp√©cialis√©s.
 */
class DashboardModel {
    /**
     * @var ImportModel $importModel Instance pour r√©cup√©rer les donn√©es
     */
    private $importModel;

    /**
     * @var LectureDossierModel $lectureDossierModel Instance pour la conversion
     */
    private $lectureDossierModel;

    /**
     * Constructeur du DashboardModel
     */
    public function __construct() {
        // Utiliser le Singleton pour ImportModel
        $this->importModel = ImportModel::getInstance();
        $this->lectureDossierModel = new LectureDossierModel();
    }

    /**
     * R√©cup√®re les informations de l'utilisateur
     *
     * @param string $userId ID de l'utilisateur
     * @return array Informations de l'utilisateur
     */
    public function getUserInfo($userId) {
        // Informations basiques de l'utilisateur
        return [
            'id' => $userId,
            'nom' => $userId // Utiliser l'ID comme nom par d√©faut
        ];
    }

    /**
     * R√©cup√®re toutes les donn√©es depuis la base de donn√©es
     *
     * @return array Donn√©es de la table Donnees
     */
    public function getAllData() {
        return $this->importModel->getAllData();
    }

    /**
     * V√©rifie si des donn√©es sont pr√©sentes
     *
     * @return bool True si des donn√©es existent
     */
    public function hasData() {
        return $this->importModel->hasData();
    }

    /**
     * R√©cup√®re les statistiques des donn√©es pour le dashboard
     *
     * @return array Statistiques basiques
     */
    public function getDataSummary() {
        $donnees = $this->importModel->getAllData();

        if (empty($donnees)) {
            return [
                'total_entries' => 0,
                'date_debut' => null,
                'date_fin' => null,
                'processus_uniques' => 0
            ];
        }

        $dates = array_column($donnees, 'Date');
        $processus = array_unique(array_column($donnees, 'Processus'));

        return [
            'total_entries' => count($donnees),
            'date_debut' => min($dates),
            'date_fin' => max($dates),
            'processus_uniques' => count($processus)
        ];
    }

    /**
     * Lance le processus de conversion cibl√©e par num√©ro d'affaire
     *
     * @param string $numeroAffaire Num√©ro d'affaire pour conversion cibl√©e (obligatoire)
     * @return array R√©sultat du processus complet
     */
    public function processConversion($numeroAffaire) {
        if (empty($numeroAffaire)) {
            return [
                'success' => false,
                'message' => 'Le num√©ro d\'affaire est obligatoire pour la conversion cibl√©e.'
            ];
        }

        // Conversion cibl√©e par num√©ro d'affaire
        $result = $this->lectureDossierModel->processFileByNumber($numeroAffaire);

        // Forcer le rechargement des donn√©es apr√®s la conversion
        $this->importModel->refreshData();

        return $result;
    }

    /**
     *Supprime un fichier XLSX converti par num√©ro d'affaire et reconstruit la BD
     *
     * @param string $numeroAffaire Num√©ro d'affaire du fichier √† supprimer
     * @return array R√©sultat de la suppression et reconstruction
     */
    public function deleteConvertedFileByNumber($numeroAffaire) {
        $result = [
            'success' => false,
            'message' => '',
            'numero_affaire' => $numeroAffaire,
            'file_deletion' => null,
            'database_clear' => null,
            'reconstruction' => null
        ];

        try {
            // √âtape 1 : Supprimer le fichier via LectureDossierModel
            $fileDeletionResult = $this->lectureDossierModel->deleteConvertedFileByNumber($numeroAffaire);
            $result['file_deletion'] = $fileDeletionResult;

            if (!$fileDeletionResult['success']) {
                $result['message'] = $fileDeletionResult['message'];
                return $result;
            }

            // √âtape 2 : Vider la base de donn√©es via ImportModel
            $databaseClearResult = $this->importModel->clearTable();
            $result['database_clear'] = $databaseClearResult;

            if (!$databaseClearResult) {
                $result['message'] = "Fichier supprim√© mais erreur lors du vidage de la base de donn√©es.";
                return $result;
            }

            // √âtape 3 : Obtenir la liste des fichiers XLSX restants
            $remainingFiles = $this->lectureDossierModel->getAllConvertedFiles();

            // √âtape 4 : R√©importer tous les fichiers restants
            $reconstructionResult = $this->reconstructDatabaseFromFiles($remainingFiles);
            $result['reconstruction'] = $reconstructionResult;

            if ($reconstructionResult['success']) {
                $result['success'] = true;
                $result['message'] = sprintf(
                    "Suppression et reconstruction termin√©es avec succ√®s !\n\n" .
                    "üóëÔ∏è Fichier supprim√© : %s\n" .
                    "üíæ Base de donn√©es vid√©e et reconstruite\n" .
                    "üìÅ Fichiers XLSX restants trait√©s : %d\n" .
                    "üìä Nouvelles entr√©es import√©es : %d\n" .
                    "‚ö†Ô∏è Erreurs d'importation : %d",
                    $fileDeletionResult['deleted_file']['name'],
                    $reconstructionResult['files_processed'],
                    $reconstructionResult['total_imported'],
                    $reconstructionResult['total_errors']
                );
            } else {
                $result['message'] = "Fichier supprim√© et base vid√©e, mais erreur lors de la reconstruction : " . $reconstructionResult['message'];
            }

        } catch (\Exception $e) {
            $result['message'] = "Erreur inattendue lors du processus : " . $e->getMessage();
        }

        return $result;
    }

    /**
     *Reconstruit la base de donn√©es √† partir d'une liste de fichiers XLSX
     *
     * @param array $files Liste des fichiers √† importer
     * @return array R√©sultat de la reconstruction
     */
    private function reconstructDatabaseFromFiles($files) {
        $result = [
            'success' => false,
            'message' => '',
            'files_processed' => 0,
            'total_imported' => 0,
            'total_errors' => 0,
            'details' => []
        ];

        try {
            if (empty($files)) {
                $result['success'] = true;
                $result['message'] = "Aucun fichier XLSX √† r√©importer";
                return $result;
            }

            // Initialiser ExcelToBdModel pour l'importation
            $excelToBdModel = new \modules\blog\models\ExcelToBdModel();

            // R√©importer chaque fichier XLSX
            foreach ($files as $fileInfo) {
                $importResult = $excelToBdModel->importExcelToDatabase($fileInfo['path']);
                $result['files_processed']++;

                if ($importResult['success']) {
                    $result['total_imported'] += $importResult['importCount'];
                } else {
                    $result['total_errors']++;
                }

                $result['details'][] = [
                    'file' => $fileInfo['name'],
                    'success' => $importResult['success'],
                    'imported' => $importResult['importCount'] ?? 0,
                    'message' => $importResult['message']
                ];
            }

            $result['success'] = true;
            $result['message'] = sprintf(
                "R√©importation termin√©e: %d fichier(s) trait√©(s), %d entr√©e(s) import√©e(s), %d erreur(s)",
                $result['files_processed'],
                $result['total_imported'],
                $result['total_errors']
            );

        } catch (\Exception $e) {
            $result['message'] = "Erreur lors de la r√©importation : " . $e->getMessage();
        }

        return $result;
    }

    /**
     * Vide la table de donn√©es
     *
     * @return array R√©sultat de l'op√©ration
     */
    public function clearData() {
        $success = $this->importModel->clearTable();

        return [
            'success' => $success,
            'message' => $success ?
                "La table de donn√©es a √©t√© vid√©e avec succ√®s." :
                "Erreur lors de la suppression des donn√©es."
        ];
    }

    /**
     * Force le rechargement des donn√©es depuis la base
     *
     * @return bool Succ√®s du rechargement
     */
    public function refreshData() {
        return $this->importModel->refreshData();
    }

    /**
     * R√©cup√®re des donn√©es limit√©es pour l'affichage (compatibilit√©)
     *
     * @param int $limit Nombre d'entr√©es √† retourner
     * @return array Donn√©es limit√©es
     */
    public function getRecentData($limit = 50) {
        $donnees = $this->importModel->getAllData();

        // Trier par date d√©croissante et limiter
        usort($donnees, function($a, $b) {
            return strcmp($b['Date'], $a['Date']);
        });

        return array_slice($donnees, 0, $limit);
    }

    /**
     * Obtenir la liste des fichiers MPP disponibles (pour info)
     *
     * @return array Liste des fichiers MPP
     */
    public function getMppFilesList() {
        return $this->lectureDossierModel->getMppFiles();
    }

    /**
     * Obtenir la liste des fichiers XLSX convertis (pour info)
     *
     * @return array Liste des fichiers XLSX
     */
    public function getXlsxFilesList() {
        return $this->lectureDossierModel->getXlsxFiles();
    }

    /**
     * Obtenir la liste d√©taill√©e des fichiers XLSX convertis (avec num√©ros d'affaire)
     *
     * @return array Liste d√©taill√©e des fichiers XLSX
     */
    public function getXlsxFilesDetailed() {
        return $this->lectureDossierModel->getXlsxFilesDetailed();
    }
}